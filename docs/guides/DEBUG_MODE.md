# Debug Mode Documentation

## Overview

The Debug Mode feature provides a transparent technical layer for debugging and analyzing the Natal Nataly astrology bot. This debug-first architecture allows developers to inspect every stage of the processing pipeline, from raw user input to final astrological readings.

## Architecture Philosophy

> **"–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –≤—Ç–æ—Ä–∏—á–Ω—ã. –ò—Å—Ç–∏–Ω–∞ ‚Äî –≤ –¥–∞–Ω–Ω—ã—Ö."**
> 
> _"Interpretations are secondary. Truth is in the data."_

The debug mode implements a philosophy where:
- All pipeline stages are logged and traceable
- Natal charts are stored once and reused
- LLM prompts and parameters are tracked for reproducibility
- Timezone validation ensures data accuracy
- SVG visualizations enable visual verification

## Configuration

### Environment Variables

Add to your `.env` file:

```bash
# Enable debug mode
DEBUG_MODE=true

# Developer Telegram ID (required for debug commands)
# Get your ID by messaging @userinfobot on Telegram
DEVELOPER_TELEGRAM_ID=your_telegram_id_here
```

### Database Schema

Debug mode adds three new tables:

1. **`pipeline_logs`** - Tracks each stage of the processing pipeline
2. **`natal_charts`** - Stores complete natal charts with versioning
3. **`debug_sessions`** - Links pipeline stages for complete trace

Enhanced existing tables:
- **`readings`** - Added `prompt_name`, `prompt_hash`, `model_used` fields

## Pipeline Stages

### Stage 1: Raw Input
**What:** Original user message as received from Telegram  
**Stored:** `raw_user_message`, `telegram_id`, `timestamp`  
**Log:** `[PIPELINE] RAW_INPUT_OK`

### Stage 2: Parsed Birth Data (LLM Output)
**What:** Structured data extracted by LLM from natural language  
**Stored:** Complete JSON with `dob`, `time`, `lat`, `lng`, `timezone`, `confidence`  
**Log:** `[PIPELINE] LLM_PARSE_OK`  
**Note:** This is stored BEFORE any system transformations

### Stage 3: Normalized Birth Data
**What:** Validated and normalized data after system processing  
**Stored:** 
- `normalized_birth_data_json`
- `birth_datetime_utc` and `birth_datetime_local`
- `timezone`, `timezone_source` (api|fallback|manual)
- `timezone_validation_status` (MATCH|MISMATCH)
- `coordinates_source`

**Log:** `[PIPELINE] NORMALIZED_OK` or `[PIPELINE] TZ_MISMATCH`

### Stage 4: Astrology Engine Output
**What:** Complete natal chart generated by Swiss Ephemeris  
**Stored:** 
- Full chart JSON (planets, houses, angles)
- `engine_version` (pyswisseph version)
- `ephemeris_version` (Swiss Ephemeris data version)
- `chart_hash` (for quick comparison)
- Optional `raw_ephemeris_data`

**Log:** `[PIPELINE] CHART_GENERATED_OK`

### Stage 5: Reading Sent
**What:** LLM-generated astrological interpretation delivered to user  
**Stored:** Reading text, prompt name, prompt hash, model used  
**Log:** `[PIPELINE] READING_SENT_OK`

## Developer Commands

All debug commands are only accessible when:
1. `DEBUG_MODE=true` in `.env`
2. User's Telegram ID matches `DEVELOPER_TELEGRAM_ID`

### `/debug_birth`

Shows parsed and normalized birth data for the latest session.

**Output includes:**
- Session ID and timestamp
- Parsed data (raw LLM output JSON)
- Normalized data (after validation)
- Timezone information and validation status
- UTC and local birth times
- Coordinates and their source

**Example:**
```
üîç DEBUG: Birth Data

üìù Session ID: `a7f3c9d2-1e4b-4c5a-9f8e-2d1c3b4a5e6f`
‚è∞ Timestamp: 2026-02-09 18:30:45 UTC

üìã Parsed Data (LLM Output):
{
  "dob": "1990-05-15",
  "time": "14:30",
  "lat": 40.7128,
  "lng": -74.0060,
  "timezone": "UTC-5",
  "confidence": 0.95
}

‚úÖ Normalized Data (System Validated):
{
  "dob": "1990-05-15",
  "time": "14:30",
  "lat": 40.7128,
  "lng": -74.0060,
  "timezone": "America/New_York"
}

üåç Timezone: America/New_York
üìç Timezone Source: api
‚úîÔ∏è Validation Status: MATCH
```

### `/debug_chart`

Shows complete natal chart JSON with metadata.

**Output includes:**
- Chart ID and creation timestamp
- Engine version (pyswisseph)
- Ephemeris version
- Chart hash (first 16 characters)
- Complete birth data
- Full natal chart JSON

**Example:**
```
üîÆ DEBUG: Natal Chart

üÜî Chart ID: 42
‚è∞ Created: 2026-02-09 18:31:02 UTC
üîß Engine Version: 2.10.03
üìö Ephemeris Version: SE 2.10
#Ô∏è‚É£ Chart Hash: `a7f3c9d21e4b4c5a...`

üìä Birth Data:
{
  "dob": "1990-05-15",
  "time": "14:30",
  "lat": 40.7128,
  "lng": -74.0060
}

üåü Natal Chart:
{
  "Sun": {"degree": 24.5, "sign": "Taurus"},
  "Moon": {"degree": 15.3, "sign": "Pisces"},
  ...
}
```

### `/debug_pipeline`

Shows complete pipeline trace for the latest session.

**Output includes:**
- Session ID and timing
- Status of each pipeline stage
- Confidence scores
- Timezone validation results
- Links to chart and reading IDs
- LLM prompt metadata (name, hash, model)
- Any error messages

**Example:**
```
üîç DEBUG: Complete Pipeline Trace

üÜî Session ID: `a7f3c9d2-1e4b-4c5a-9f8e-2d1c3b4a5e6f`
‚è∞ Started: 2026-02-09 18:30:45 UTC
‚úÖ Completed: 2026-02-09 18:31:15 UTC
üìä Status: completed

Pipeline Stages:

1Ô∏è‚É£ Raw Input
   üìù Message: `I was born on May 15, 1990 at 2:30 PM in New York...`
   ‚è∞ Time: 18:30:45

2Ô∏è‚É£ LLM Parse ‚úÖ
   üìä Confidence: 0.95

3Ô∏è‚É£ Normalization ‚úÖ
   üåç Timezone: America/New_York
   ‚úîÔ∏è TZ Status: MATCH

4Ô∏è‚É£ Chart Generated ‚úÖ
   üÜî Chart ID: 42

5Ô∏è‚É£ Reading Sent ‚úÖ
   üÜî Reading ID: 15

LLM Prompt Info:
   üìã Prompt: astrologer_chat
   #Ô∏è‚É£ Hash: `7a8b9c0d1e2f3g4h`
   ü§ñ Model: openai/gpt-oss-20b
```

### `/show_chart`

Generates and displays SVG visualization of the natal chart.

**Features:**
- Zodiac wheel with 12 houses
- Planetary positions marked with symbols
- Color-coded planets
- Saves to `/charts/{telegram_id}.svg`

**Output:**
```
üîÆ Natal Chart Visualization

‚úÖ SVG chart generated and saved to: `./charts/12345.svg`

Planetary Positions:
‚Ä¢ Sun: Taurus 24.50¬∞
‚Ä¢ Moon: Pisces 15.30¬∞
‚Ä¢ Mercury: Gemini 8.20¬∞
...
```

## Timezone Validation

The system performs automatic timezone validation by:

1. **LLM Extraction**: Timezone extracted from user's natural language input
2. **Geo Lookup**: Estimated timezone based on coordinates
3. **Comparison**: Results are compared and status is recorded

**Validation Statuses:**
- `MATCH` - LLM and geo lookup agree
- `MISMATCH` - Discrepancy detected (warning logged)
- `NO_VALIDATION` - No LLM timezone provided
- `ERROR` - Validation process failed

**Warning Example:**
```
‚ö†Ô∏è [PIPELINE] TZ_MISMATCH - Timezone validation failed
   LLM: UTC-5
   Estimated: UTC-4
```

## Natal Chart Storage

Charts are stored once and reused for all subsequent readings, ensuring:
- **Consistency**: Same chart used across all interpretations
- **Performance**: No recalculation needed
- **Reproducibility**: Chart can be regenerated with same version
- **Versioning**: Track engine versions for debugging

**Storage includes:**
- Birth data (dob, time, coordinates)
- Complete natal chart (planets, houses, aspects)
- Swiss Ephemeris version
- Engine version (pyswisseph)
- Chart hash for quick validation
- Optional raw ephemeris data

## LLM Prompt Tracking

Every reading stores:
- **Prompt Name**: Which prompt template was used
- **Prompt Hash**: SHA256 hash of prompt content (first 16 chars)
- **Model Used**: LLM model identifier

This enables:
- **Reproducibility**: Regenerate reading with same prompt
- **Version Control**: Track prompt changes over time
- **A/B Testing**: Compare different prompt versions
- **Debugging**: Identify which prompt caused issues

## SVG Chart Visualization

The SVG generator creates visual charts with:

**Features:**
- 600x600px resolution
- Zodiac wheel with 12 segments
- Planetary positions with symbols
- Color-coded planets:
  - Sun: Gold (#FFD700)
  - Moon: Silver (#C0C0C0)
  - Mars: Red (#FF4500)
  - Jupiter: Blue (#4169E1)
  - Saturn: Brown (#8B4513)
  - etc.

**Technical Details:**
- Pure SVG (no external dependencies)
- Mathematical placement of planets
- Scalable vector format
- Saves to `./charts/` directory

## Usage Examples

### Developer Workflow

1. **User sends birth data**
   ```
   DOB: 1990-05-15
   Time: 14:30
   Location: New York
   ```

2. **Check parsing accuracy**
   ```
   /debug_birth
   ```
   ‚Üí Verify LLM extracted correct data
   ‚Üí Check timezone validation status

3. **Inspect generated chart**
   ```
   /debug_chart
   ```
   ‚Üí Review planetary positions
   ‚Üí Verify chart hash

4. **View visual representation**
   ```
   /show_chart
   ```
   ‚Üí Visual sanity check
   ‚Üí Compare with reference charts

5. **Trace complete pipeline**
   ```
   /debug_pipeline
   ```
   ‚Üí Review all stages
   ‚Üí Check for errors or warnings
   ‚Üí Verify LLM prompt used

### Troubleshooting Scenarios

**Problem:** User reports incorrect interpretation

**Debug Steps:**
1. `/debug_pipeline` - Find the session
2. `/debug_birth` - Verify input parsing
3. `/debug_chart` - Check chart accuracy
4. Review reading in database with prompt info
5. Test prompt with same chart to reproduce

**Problem:** Timezone seems wrong

**Debug Steps:**
1. `/debug_birth` - Check timezone validation status
2. Review `timezone_validation_status` field
3. Compare LLM timezone vs. geo lookup
4. Check coordinates accuracy

**Problem:** Chart looks incorrect

**Debug Steps:**
1. `/show_chart` - Visual inspection
2. `/debug_chart` - Review raw data
3. Check `engine_version` and `ephemeris_version`
4. Verify birth datetime (UTC vs. local)

## Best Practices

1. **Always check pipeline** after major changes
2. **Monitor timezone mismatches** - they indicate data quality issues
3. **Store chart hashes** for quick comparison
4. **Track prompt versions** when changing prompts
5. **Use SVG visualization** for quick visual validation
6. **Keep DEBUG_MODE off in production** (performance overhead)

## Performance Considerations

When `DEBUG_MODE=true`:
- Additional database writes for each stage
- Pipeline logs can grow large over time
- Consider periodic cleanup of old logs
- SVG generation adds minimal overhead

**Recommended:**
- Use debug mode during development and testing
- Disable for production unless troubleshooting
- Set up log rotation/cleanup jobs

## Security

**Important:**
- Debug commands are **developer-only**
- Non-developers get "‚õî Debug commands are only available to the developer"
- Never share `DEVELOPER_TELEGRAM_ID` publicly
- Pipeline logs may contain sensitive birth data
- Secure database access appropriately

## Future Enhancements

Potential additions to debug mode:
- [ ] Export complete session as JSON
- [ ] Compare two charts side-by-side
- [ ] Replay pipeline from saved session
- [ ] Advanced timezone lookup with real API
- [ ] Interactive SVG with tooltips
- [ ] Historical chart versions comparison
- [ ] Automated testing with saved sessions

## Conclusion

Debug mode transforms Natal Nataly from a black box into a transparent, inspectable system. By logging every stage and storing complete data, developers can:

- Trust the accuracy of interpretations
- Quickly identify and fix issues
- Reproduce any reading from history
- Validate calculations visually
- Track system evolution over time

**Remember:** *–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ç–µ–º–∞—Ç–∏–∫—É. –ü–æ—Ç–æ–º —Å–º—ã—Å–ª.*  
_"First we verify the mathematics. Then the meaning."_
